<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ege Güney Kıymaç">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>EqSearch - MacroSim Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MacroSim Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Class Documentations</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../SeriesAccessor/" class="dropdown-item">SeriesAccessor</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">EqSearch</a>
</li>
                                    
<li>
    <a href="../GrowthPatternDetector/" class="dropdown-item">GrowthPatternDetector</a>
</li>
                                    
<li>
    <a href="../BaseVarSelector/" class="dropdown-item">BaseVarSelector</a>
</li>
                                    
<li>
    <a href="../SimEngine/" class="dropdown-item">SimEngine</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">About</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LICENSE" class="dropdown-item">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../SeriesAccessor/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../GrowthPatternDetector/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#eqsearch" class="nav-link">EqSearch</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#example-usage" class="nav-link">Example Usage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#methods" class="nav-link">Methods</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#eqsearchdistil_split" class="nav-link">EqSearch.distil_split</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#eqsearchsearch" class="nav-link">EqSearch.search</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="eqsearch">EqSearch</h1>
<p><code>EqSearch</code> is responsible with applying symbolic regression to derive target equations for simulation. 
It utilizes pysr's <code>PySRRegressor</code> model, which is written and pre-compiled in julia. As an important note,
pysr is currently in development and <code>UnicodeDecodeError</code>s are common during equation searches. 
(only tested in ipython environments)  Although raised, these byte decode errors do not interrupt the runtime and
better ipython support will likely be implemented at some point.</p>
<p>To generalize the output expressions, an aggressive outlier elimination process is applied in <code>EqSearch</code>. This increases
the chances of getting differentiable and interpretable outputs. n-neighbor based outlier detection is implemented with
<code>sklearn</code>'s <code>LocalOutlierFactor</code> model and after the LOF based outlier elimination, the remaining data is further distilled
through the use of a <code>RandomForestRegressor</code>. Following this procedure, <code>PySRRegressor</code> is utilized to conduct an iterative
search for the best fitting symbolic expression within the user-defined constraints.</p>
<h2 id="example-usage">Example Usage</h2>
<pre><code class="language-python">from macrosim import EqSearch
from pandas import DataFrame, Series
from sympy import sin

x: DataFrame = ...
y: Series | DataFrame = ... 

eqsr = EqSearch(
    X=x,  # features
    y=y,  # label
    random_state=0,
    model_selection='best'
)

eqsr.distil_split(grid_search=False)  # Model distillation (required step)
eqsr.search(
    extra_unary_ops={
        'sin': {
            'julia': 'sin',
            'sympy': lambda x: sin(x)
        }
    },
    constraints={'sin': 2, '^': (-1, 1)} # Complexity limit of terms in binary and unary operations 
)

eq = eqsr.eq
</code></pre>
<h1 id="methods">Methods</h1>
<h2 id="eqsearchdistil_split"><code>EqSearch.distil_split</code></h2>
<p>Applies outlier handling and model distillation.</p>
<p><strong>Params:</strong>
- <code>test_size: float</code>: test size used for the data split of <code>RandomForestRegressor</code>.
- <code>grid_search: bool</code>: Conduct cross-validated grid search for <code>RandomForestRegressor</code> tuning if True.
- <code>gs_params: dict[str, list[Any]]</code>: Param grid to use if <code>grid_search=True</code>.</p>
<p><strong>Returns:</strong>
- <code>None</code></p>
<h2 id="eqsearchsearch"><code>EqSearch.search</code></h2>
<p>Uses <code>PySRRegressor</code> to conduct a symbolic expression search. Calling <code>search</code> before <code>distil_split</code> will raise an
<code>AssertionError</code>. Records the resulting equation as a <code>sympy</code> expression to <code>self.eq</code>.</p>
<p><strong>Params:</strong>
- <code>binary_ops: tuple[str]</code>: tuple of binary operators (as strings) allowed in the final expression. Defaults to use all 
binary operators available.</p>
<ul>
<li>
<p><code>unary_ops: tuple[str]</code>: tuple of unary operators allowed in the final expression. Defaults to <code>('exp', 'log', 'sqrt')</code>.</p>
</li>
<li>
<p><code>extra_unary_ops: dict[str, dict[str, Any]]</code>: dict of unary ops that are not built-in to python, sympy, or julia. Every search
will include the extra unary: <code>{'inv': {julia: 'inv(x)=1/x', 'sympy': lambda x: 1/x}</code>. For each operator, a julia and sympy
applicable definition is necessary. julia implementations are passed as strings in julia syntax, to be parsed on the
<code>PySRRegressor</code> side.</p>
</li>
<li>
<p><code>custom_loss: str</code>: elementwise loss function to use, either written in julia syntax or a string literal for predefined loss
functions, available in <a href="https://ai.damtp.cam.ac.uk/symbolicregression/dev/losses/">PySR documentation</a>. Defaults to 'L2DistLoss()'. (sum of square difference, similar to MSE)</p>
</li>
<li>
<p><code>constraints: dict[str, Union[int, tuple[int, int]]</code>: constraints to expression complexity of binary and unary operations. 
Complexity, in this case, refers to the amount of operations required to reduce an input to its simplest form. For example, 
<code>1+1</code>can be reduced to it's simplest form in one addition, making it's overall complexity equal to 1 while <code>a*1+1</code> would 
require at least 2 operations, so it has a complexity of 2. (assuming a is a scalar) For unary operations, an integer is 
passed to define how complex of an input can be used. For example, a complexity of 1 would only allow a single variable 
or constant. With a complexity of 1, the <code>sin</code> operator would only be used as <code>sin(x)</code> while a  complexity of 2 would 
for example allow <code>sin(x+C)</code>. Binary operators function similarly, but their constraints are defined as a tuple of 
integers, for the inputs <code>x</code>, and <code>y</code> of the operation. For example, a constraint of <code>(1, 1)</code> on the <code>^</code> operator would 
only allow expressions of type <code>x^y</code> while a constraint of (2, 1) would allow <code>(x+1)^y</code>.</p>
</li>
</ul>
<p><strong>Returns:</strong>
- <code>None</code> (Results saved to <code>self.eq</code>)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/contrib/auto-render.min.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
